# 技术架构思考文档

> **文档状态**：思考中，待确认
> **更新日期**：2025-01-03

---

## 一、产品定位

**智能情绪桌面摆件** - 一个结合硬件与AI的个人情绪追踪设备

核心功能：
1. 采集环境数据（温湿度、光照、天气）
2. 记录用户情绪状态
3. 分析环境与情绪的关联
4. 提供个性化的情绪洞察和建议

---

## 二、当前架构的问题

| 缺失项 | 现状 | 影响 |
|--------|------|------|
| App后端 | 没有 | App没有API可用 |
| 云端服务 | 没有设计 | 硬件数据存哪里？用户数据怎么同步？ |
| 实时同步 | 没有 | App无法实时查看数据 |
| 用户系统 | 没有 | 无法区分用户、数据无法归属 |
| 真正AI模型 | 只有规则算法 | 情绪分析能力有限 |
| 端侧AI | 未确定 | 是否要在App端运行模型？ |

---

## 三、架构设计（待确认）

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户层                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │  硬件设备   │  │   App(iOS   │  │  Claude     │             │
│  │  (ESP32)    │  │  /Android)  │  │  Desktop    │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
                              │
         ┌────────────────────┼────────────────────┐
         ▼                    ▼                    ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│   硬件通信协议    │ │   App API        │ │   MCP Protocol   │
│   (MQTT/HTTP)    │ │   (REST/WebSocket)│ │   (已实现)       │
└──────────────────┘ └──────────────────┘ └──────────────────┘
         │                    │                    │
         └────────────────────┼────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        云端服务层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │  API Gateway│  │  Auth服务   │  │  实时同步   │             │
│  │  (统一入口)  │  │  (用户鉴权)  │  │  (WebSocket)│             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │  设备管理   │  │  数据存储   │  │  AI服务     │             │
│  │  (设备注册)  │  │  (时序+关系) │  │  (洞察分析)  │             │
│  └─────────────┘  └─────────────┘  └──────────────────┐        │
└─────────────────────────────────────────────────────────────────┘
```

---

## 四、关键决策点

### 4.1 AI模型选型

| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| **端侧AI** (TF Lite/Core ML) | 隐私好、延迟低、离线可用、成本低 | 模型小、能力有限 | 实时情绪推断、快速响应 |
| **云端LLM** (GPT-4o/Claude) | 能力强、可更新 | 延迟高、需联网、按量付费 | 深度洞察分析、长报告生成 |
| **混合方案** ⭐ | 综合两者优点 | 复杂度较高 | 推荐方案 |

**当前倾向**：端侧AI（待验证可行性）

### 4.2 部署方式

| 方案 | 优点 | 缺点 |
|------|------|------|
| **云服务** (AWS/阿里云) | 成熟、可扩展 | 需要运维 |
| **Serverless** (Supabase/Vercel) | 无运维、按需付费 | 有冷启动限制 |
| **自建服务器** | 完全控制 | 成本高、需运维 |

**当前倾向**：云服务或 Serverless

### 4.3 实时同步

**需要** - App需要实时查看硬件数据（如实时温湿度）

方案：WebSocket + 消息队列 (MQTT)

---

## 五、技术栈建议

| 层级 | 推荐选项 | 说明 |
|------|----------|------|
| **App框架** | Flutter / React Native | 跨平台 |
| **后端平台** | Supabase / Firebase | Serverless，集成数据库+Auth+实时 |
| **实时同步** | Supabase Realtime | WebSocket 数据变更推送 |
| **端侧AI** | TensorFlow Lite / Core ML | 轻量模型推理 |
| **云端AI** | OpenAI / Anthropic API | 深度分析 |
| **硬件云端** | AWS IoT / 阿里云IoT | 设备管理 |
| **硬件通信** | MQTT | 低功耗IoT协议 |
| **数据库** | InfluxDB (时序) + PostgreSQL (关系) | 时序数据+用户数据分离 |

---

## 六、数据流设计

### 6.1 实时数据流（温湿度/光照）

```
ESP32 ──→ MQTT ──→ 云端 ──→ WebSocket ──→ App实时显示
     │           │         │
     └─→ 本地存储─┘         └─→ 时序数据库
```

### 6.2 用户操作流（记录情绪）

```
用户打分 ──→ App端AI推断(可选) ──→ 云端存储
                │
                └────────→ WebSocket通知设备 (改变灯光/显示)
```

### 6.3 洞察生成流

```
用户请求洞察 ──→ 读取历史数据 ──→ 端侧AI快速分析
                          │
                  (需要深度分析时)
                          └─→ 云端LLM生成报告
```

---

## 七、MCP的位置

MCP作为 **AI助手专用通道**，与App的REST API共用底层数据：

```
┌─────────────────────────────────────────┐
│            Claude Desktop               │
│         (用户使用AI助手对话)             │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│              MCP Server                 │
│    (保持现有设计，作为AI接入层)          │
│         ┌──────────────┐               │
│         │ 工具: 查询   │               │
│         │ 工具: 记录   │               │
│         │ 工具: 洞察   │               │
│         └──────────────┘               │
└─────────────────────────────────────────┘
                    │
                    ▼
            ┌──────────────┐
            │   云端API     │  ← App也调用这套API
            └──────────────┘
```

---

## 八、待确认事项

- [ ] AI模型选型（端侧 vs 云端 vs 混合）
- [ ] 部署平台选择（Supabase/AWS/自建）
- [ ] App技术栈（Flutter/React Native）
- [ ] 硬件云端方案（AWS IoT/阿里云/自建）
- [ ] 数据存储方案（分离式还是统一）
- [ ] 用户系统设计（是否需要多设备支持）

---

## 九、参考链接

- MCP协议: https://modelcontextprotocol.io/
- Supabase: https://supabase.com/
- TensorFlow Lite: https://www.tensorflow.org/lite
- ESP32-S3: https://docs.espressif.com/

---

*本文档为内部思考文档，方案待确认后会整理为正式的技术架构文档。*
