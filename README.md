# 智能情绪桌面摆件 (EmotionSense Desktop Companion)

**版本**: v2.0 混合架构版
**更新**: 2026年1月12日

---

## 🎯 核心亮点

一个采用**本地+云端混合架构**的智能情绪桌面设备，在树莓派5上实现：

- 🏠 **本地AI**: Whisper ASR + Piper TTS + TinyLlama（离线可用）
- ☁️ **云端增强**: Claude API 处理复杂对话（高质量低成本）
- 🌡️ **环境感知**: 温湿度、光照、天气数据
- 📝 **情绪洞察**: 基于长期数据的个性化分析
- 🔐 **隐私优先**: 对话优先本地处理，敏感数据不出设备

---

## 🏗️ 混合架构设计

```
┌─────────────────────────────────────────────────────────────────────┐
│                    MindNote 混合架构                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Layer 1: 语音交互层                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                 │
│  │  本地 ASR   │  │  本地 TTS   │  │  本地 VAD   │                 │
│  │ Sherpa-onnx │  │   Piper     │  │  WebRTC     │                 │
│  │  离线识别   │  │  本地合成   │  │  语音检测   │                 │
│  └─────────────┘  └─────────────┘  └─────────────┘                 │
│                                                                     │
│  Layer 2: 对话引擎层                                                 │
│  ┌───────────────────┐      ┌───────────────────┐                  │
│  │    本地处理       │      │    云端处理       │                  │
│  │  - 意图分类       │      │  - 情感对话       │                  │
│  │  - 设备控制       │ ───→ │  - 复杂问答       │                  │
│  │  - 简单查询       │      │  - 洞察生成       │                  │
│  └───────────────────┘      └───────────────────┘                  │
│            │                        │                                │
│            ▼                        ▼                                │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      Claude API                              │   │
│  │                   (云端深度对话)                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  Layer 3: 数据服务层                                                 │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                   SQLite 本地数据库                          │   │
│  │     对话记录 │ 情绪数据 │ 环境数据 │ 用户画像               │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 延迟对比

| 环节 | 本地方案 | 云端方案 | 混合方案 |
|------|---------|---------|---------|
| ASR | 500-1000ms | 300-500ms | 本地优先 |
| TTS | 50-150ms | 200-400ms | 本地优先 |
| LLM | 5-15 tok/s | 500-1500ms | 简单本地，复杂云端 |
| **端到端** | 2-5秒 | 1.1-2.5秒 | **1.5-3秒** |

---

## 💻 硬件方案（树莓派5）

```
┌─────────────────────────────────────────────────────────────┐
│                    MindNote 硬件配置                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │              树莓派 5 (4GB)                          │  │
│   │  • 4核 Cortex-A76 @ 2.4GHz                          │  │
│   │  • 4GB LPDDR4X RAM                                  │  │
│   │  • 支持 Vulkan 1.2                                   │  │
│   │  • 运行 Ubuntu 24.04 Server                         │  │
│   └─────────────────────────────────────────────────────┘  │
│            │           │           │           │             │
│            ▼           ▼           ▼           ▼             │
│   ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │
│   │ USB麦克风 │ │ 扬声器   │ │ 传感器   │ │ LED灯    │      │
│   │ (桌面麦) │ │(蓝牙/3.5)│ │ SHT30    │ │ WS2812   │      │
│   └──────────┘ └──────────┘ └──────────┘ └──────────┘      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 成本清单

| 配件 | 型号 | 价格 | 备注 |
|------|------|------|------|
| 树莓派5 4GB | 已有 | ¥0 | 用户已有 |
| 电源 | 官方PD 5V/5A | ¥100 | 必须品 |
| SD卡 | 64GB | ¥50 | 系统盘 |
| USB麦克风 | 桌面USB麦 | ¥50 | 即插即用 |
| 蓝牙音箱 | 自备 | ¥0 | 或3.5mm音箱 |
| SHT30传感器 | I2C模块 | ¥15 | 温湿度 |
| 杜邦线 | 公母头 | ¥5 | 连接传感器 |
| **总计** | - | **¥220-270** | 不含自备设备 |

---

## 🤖 本地模型配置

### ASR - Sherpa-onnx (离线识别)

```yaml
模型: sherpa-onnx-conformer-zh-small-2024-07-17
大小: ~40MB
内存: ~400MB
RTF: 0.2-0.3 (4倍速实时)
准确率: ~95%
```

### TTS - Piper (本地语音合成)

```yaml
模型: zh_CN_Huayan-medium.onnx
大小: ~50MB
内存: ~200MB
延迟: <150ms
音质: MOS 3.5-4.0
```

### LLM - TinyLlama (轻量本地对话)

```yaml
模型: TinyLlama-1.1B-Chat.Q4_0.gguf
大小: ~700MB
内存: ~800MB
速度: 10-15 tokens/second
用途: 简单对话降级、离线备用
```

### 内存预算

| 组件 | 占用 | 备注 |
|------|------|------|
| 系统及服务 | 400MB | Ubuntu + Python |
| ASR (Sherpa) | 400MB | 模型预加载 |
| TTS (Piper) | 200MB | 模型预加载 |
| LLM (TinyLlama) | 800MB | 按需加载 |
| 数据库及其他 | 200MB | SQLite + 服务 |
| **总计** | **~2GB** | 剩余 2GB 可用 |

---

## ☁️ 云端服务配置

### 国产大模型 (情感对话)

**推荐：豆包 Doubao-Seed-1.6-lite**

| 服务商 | 模型 | 月成本 | 特点 |
|--------|------|--------|------|
| **豆包** | Doubao-Seed-1.6-lite | **¥0.27** ✅ | 最便宜，响应快 |
| **智谱AI** | GLM-4-Air | **¥0.27** ✅ | 能力稍强 |
| ~~Claude~~ | ~~Claude 3.5~~ | ~~¥45~~ | ~~太贵，不推荐~~ |

- 用途：复杂情感对话、深度问答
- 特点：国内访问稳定，成本极低
- 新用户赠送：豆包50万tokens，智谱2000万tokens

### 和风天气 API (室外数据)

- 用途：获取室外天气数据
- 成本：免费版可用
- 数据：温度、湿度、天气状况

---

## 🔧 技术栈

| 层级 | 技术 | 说明 |
|------|------|------|
| 系统 | Ubuntu 24.04 Server | 稳定、易用 |
| 语音ASR | Sherpa-onnx | 本地Whisper优化版 |
| 语音TTS | Piper | 本地离线TTS |
| 意图分类 | TFLite | 本地轻量模型 |
| 对话LLM | 豆包/智谱 + TinyLlama | 混合架构 |
| 数据存储 | SQLite | 本地轻量数据库 |
| 框架 | Python 3.11 + asyncio | 高性能异步 |
| 硬件 | 树莓派5 4GB | 主控设备 |

---

## 🚀 快速开始

### 硬件准备

```bash
# 1. 烧录系统
# 下载 Raspberry Pi Imager
# 烧录 Ubuntu 24.04 Server 到 SD卡

# 2. 首次启动配置
# 连接显示器、键盘、网线（或配置WiFi）
# 更新系统
sudo apt update && sudo apt upgrade -y

# 3. 安装依赖
sudo apt install -y python3-pip python3-venv git alsa-utils
```

### 软件部署

```bash
# 1. 克隆项目
git clone https://github.com/yourusername/mindnote.git
cd mindnote

# 2. 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 3. 安装依赖
pip install -r requirements.txt

# 4. 配置API密钥
cp config.example.yaml config.yaml
# 编辑 config.yaml，填入 豆包API密钥 或 智谱AI密钥

# 5. 运行
python main.py
```

### 测试语音链路

```bash
# 测试麦克风
arecord -l
arecord -D plughw:1 -f cd -t wav test.wav

# 测试扬声器
aplay test.wav

# 测试ASR
python -c "import sherpa_onnx; print('Sherpa-onnx OK')"

# 测试TTS
python -c "from tts import TTS; tts = TTS(); tts.speak('测试')"
```

---

## 📁 项目结构

```
mindnote/
├── README.md                    # 项目说明
├── requirements.txt             # Python依赖
├── config.yaml                  # 配置文件
├── main.py                      # 主程序入口
│
├── audio/                       # 语音处理层
│   ├── asr/                     # ASR模块
│   │   ├── local_asr.py        # 本地ASR (Sherpa)
│   │   └── cloud_asr.py        # 云端ASR备用
│   ├── tts/                     # TTS模块
│   │   ├── local_tts.py        # 本地TTS (Piper)
│   │   └── cloud_tts.py        # 云端TTS备用
│   ├── vad.py                  # 语音活动检测
│   └── wakeword.py             # 唤醒词检测
│
├── dialog/                      # 对话引擎层
│   ├── intent/                  # 意图分类
│   │   ├── classifier.py       # 本地意图分类
│   │   └── local_handler.py    # 本地意图处理
│   ├── llm/                     # LLM模块
│   │   ├── local_llm.py        # 本地LLM (TinyLlama)
│   │   └── cloud_llm.py        # 云端LLM (Claude)
│   └── router.py               # 对话路由器
│
├── services/                    # 数据服务层
│   ├── conversation.py         # 对话记录
│   ├── emotion.py              # 情绪分析
│   ├── environment.py          # 环境数据
│   └── insight.py              # 洞察生成
│
├── device/                      # 设备控制层
│   ├── controller.py           # 设备控制器
│   ├── led.py                  # LED灯光
│   └── sensors.py              # 传感器读取
│
├── api/                         # 开放接口层 (可选)
│   ├── rest.py                 # REST API
│   └── mcp.py                  # MCP Server
│
└── data/
    └── mindnote.db             # SQLite数据库
```

---

## 🎯 功能特性

### 核心功能

| 功能 | 实现方式 | 延迟 | 离线 |
|------|---------|------|------|
| 语音唤醒 | Porcupine (本地) | <100ms | ✅ |
| 语音识别 | Sherpa-onnx (本地) | 500-1000ms | ✅ |
| 语音合成 | Piper (本地) | <150ms | ✅ |
| 情感对话 | 豆包/智谱 (云端) | 1-2s | ❌ |
| 设备控制 | 本地处理 | <500ms | ✅ |
| 环境感知 | SHT30传感器 | - | ✅ |
| 情绪记录 | SQLite本地存储 | - | ✅ |

### 高级功能

| 功能 | 实现方式 | 备注 |
|------|---------|------|
| 意图分流 | 本地分类器 | 简单→本地，复杂→云端 |
| 离线备用 | TinyLlama | 网络故障时使用 |
| 主动关怀 | 定时任务 | 早晨/下班问候 |
| 情绪洞察 | 豆包/智谱分析 | 周报/月报生成 |

---

## 📊 性能指标

### 目标性能

| 指标 | 目标值 | 实测值 |
|------|--------|--------|
| 唤醒响应 | <500ms | - |
| 简单查询响应 | <1s | - |
| 情感对话响应 | <3s | - |
| 设备稳定运行 | >30天 | - |
| ASR准确率 | >95% | - |
| TTS延迟 | <200ms | - |

### 资源占用

| 资源 | 空闲 | 满载 |
|------|------|------|
| 内存 | ~1.5GB | ~2.5GB |
| CPU | 5-10% | 60-80% |
| 功耗 | 3-5W | 8-12W |

---

## 💰 成本分析

### 月度运营成本

| 服务 | 方案 | 月成本 |
|------|------|--------|
| 豆包/智谱API | 情感对话 | ¥0.3-0.5 |
| 和风天气 | 室外数据 | 免费 |
| **总计** | - | **¥0.3-0.5/月** |

### 对比纯云端方案

| 方案 | 月成本 | 离线能力 | 延迟 |
|------|--------|---------|------|
| 纯云端(Claude) | ¥30-45 | ❌ | 最佳 |
| 混合架构(国产) | **¥0.3-0.5** | ✅ (基础) | 良好 |
| 纯本地 | ¥0 | ✅ (完整) | 一般 |

---

## 🔒 隐私设计

### 数据流向

```
┌─────────────────────────────────────────────────────────────┐
│                        数据流向                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  本地处理（数据不出设备）                                     │
│  ├── 语音识别 (Sherpa-onnx)                                 │
│  ├── 意图分类 (TFLite)                                      │
│  ├── 设备控制 (本地执行)                                     │
│  ├── 对话记录 (SQLite本地存储)                               │
│  └── 情绪分析 (本地 + 国产API，仅发送文本)                │
│                                                             │
│  云端处理（仅发送必要数据）                                   │
│  ├── 情感对话 (仅发送对话文本，不录音)                       │
│  ├── 天气数据 (仅城市信息)                                   │
│  └── 洞察生成 (仅发送摘要，不送原始对话)                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 隐私保护措施

- 录音文件本地处理后立即删除
- 对话历史仅存储文本，不存储音频
- 云端调用仅发送脱敏后的文本
- 用户可随时导出/删除所有数据

---

## 🗓️ 开发计划

### Phase 1: 原型验证 (2-3周)

| 周次 | 目标 | 交付物 |
|------|------|--------|
| Week 1 | 系统准备、语音链路 | 录音→识别→TTS→播放 |
| Week 2 | 数据服务、传感器集成 | 环境数据采集 |
| Week 3 | 意图分流、体验优化 | 完整Demo |

### Phase 2: 功能完善 (2-3周)

| 周次 | 目标 | 交付物 |
|------|------|--------|
| Week 4 | AI人格调优 | 对话质量提升 |
| Week 5 | 主动关怀 | 定时问候功能 |
| Week 6 | 情绪洞察 | 周报/月报生成 |

### Phase 3: 产品化 (2-3周)

| 周次 | 目标 | 交付物 |
|------|------|--------|
| Week 7 | 稳定性测试 | 30天无故障 |
| Week 8 | 外壳设计 | 3D打印/亚克力外壳 |
| Week 9 | 文档完善 | 用户手册、API文档 |

---

## 📈 路线图

### 短期 (1-3个月)

- [x] 架构设计 (混合架构)
- [ ] 硬件采购 (树莓派5 + 配件)
- [ ] 语音链路打通 (ASR→LLM→TTS)
- [ ] 数据服务实现
- [ ] MVP版本发布

### 中期 (3-6个月)

- [ ] 本地模型优化 (ASR/TTS/LLM)
- [ ] AI人格迭代
- [ ] 小型化探索 (ESP32-S3)
- [ ] 开放API/SDK

### 长期 (6-12个月)

- [ ] 量产准备
- [ ] 社区建设
- [ ] 商业化探索
- [ ] 技术创新输出

---

## 🤝 贡献

这是一个个人创新项目，欢迎：

- 提交Issue反馈问题
- 提出改进建议
- 分享使用体验
- 贡献代码

---

## 📜 许可证

MIT License - 开源友好

---

**项目开始**: 2025年12月29日
**当前版本**: v2.0 混合架构版
**预计完成**: 2026年4月
